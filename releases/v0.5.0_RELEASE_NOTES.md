# Release Notes - v0.5.0

**Release Date:** January 17, 2026
**Type:** Major Feature Release - Personalized Health Insights
**Code Added:** 700+ lines
**Code Modified:** 600+ lines across 5 files

---

## üöÄ Overview

Version 0.5.0 introduces **personalized health intelligence** that adapts to your individual sleep patterns and needs. No more one-size-fits-all 8-hour targets! The system now learns your optimal sleep duration, chronotype, and scales all thresholds accordingly.

This release makes the Oura MCP Server truly personal by:
- Analyzing your chronotype using scientifically-validated MSF methodology
- Calculating your personal sleep need through readiness correlation
- Adapting all severity thresholds to your individual requirements
- Properly handling biphasic/polyphasic sleep patterns

---

## ‚ú® New Features

### 1. ü¶â Chronotype Analysis (NEW)

**Module:** `chronotype_analysis.py` (700+ lines)
**Tool:** `analyze_chronotype`

Scientific chronotype classification using **MSF (Midpoint of Sleep on Free days)** - the gold standard method from chronobiology research (Roenneberg et al.).

**Features:**
- **MSF-Based Classification:**
  - Night Owl: MSF > 5:00
  - Slight Evening Tendency: MSF 4:30-5:00
  - Intermediate: MSF 3:00-4:30
  - Slight Morning Tendency: MSF 2:30-3:00
  - Morning Lark: MSF < 2:30

- **Main Sleep Extraction:** Automatically filters out naps to analyze only your primary sleep session
- **Weekday vs Weekend Comparison:** Identifies workday sleep restriction
- **Social Jetlag Calculation:** Measures circadian misalignment
- **Activity Pattern Analysis:** Correlates chronotype with peak performance times
- **Personalized Recommendations:** Tailored advice for sleep timing, light exposure, scheduling

**Technical Implementation:**
```python
# Extracts main sleep (longest or >2h) from biphasic patterns
main_sessions = _extract_main_sleep_sessions(sleep_sessions)

# Calculates MSF for chronotype classification
msf = _calculate_sleep_midpoint(avg_bedtime, avg_waketime)

# Example: Night Owl identification
# - Average Bedtime: 01:34
# - Average Wake Time: 08:38
# - MSF: 05:06 ‚Üí Night Owl classification
```

**Example Output:**
```
ü¶â Chronotype Analysis (30 days)

Classification: Night Owl üåô

Sleep Timing:
  Average Bedtime: 01:34
  Average Wake Time: 08:38
  MSF (Midpoint of Sleep): 05:06

Social Jetlag: 1.2 hours
  Weekday Sleep Midpoint: 04:30
  Weekend Sleep Midpoint: 05:42

Recommendations:
  ‚Ä¢ Embrace your natural late schedule when possible
  ‚Ä¢ Avoid early morning commitments
  ‚Ä¢ Use blackout curtains for morning sleep
  ‚Ä¢ Get bright light exposure in afternoon
  ‚Ä¢ Schedule creative work after 10 AM
```

---

### 2. üéØ Personal Sleep Need Calculation (NEW)

**Module:** `sleep_debt.py` (enhanced)
**Feature:** Auto-detection of optimal sleep duration

Replaces the generic 8-hour target with your personal optimal sleep duration calculated through multiple methods:

**Calculation Methods:**
1. **Readiness Correlation (Primary):** Analyzes top 25% readiness days to find optimal sleep duration
2. **Sleep Score Correlation (Fallback):** Uses sleep quality scores when readiness unavailable
3. **Duration Percentile (Backup):** 75th percentile of actual sleep durations
4. **Chronotype Default (Last Resort):** 7.0h for night owls, 8.0h for others

**Technical Implementation:**
```python
# Method 1: Readiness correlation (most accurate)
def calculate_personal_sleep_need(sleep_data, readiness_data):
    # Correlate sleep duration with next-day readiness
    sleep_readiness_pairs = []
    for sleep, readiness in zip(sleep_data, readiness_data):
        duration = sleep['total_sleep_duration'] / 3600
        score = readiness['score']
        sleep_readiness_pairs.append((duration, score))

    # Find top 25% readiness days
    sorted_pairs = sorted(sleep_readiness_pairs, key=lambda x: x[1], reverse=True)
    top_25_pct = len(sorted_pairs) // 4
    top_performers = sorted_pairs[:max(top_25_pct, 5)]

    # Average sleep duration on best performance days
    optimal = statistics.mean([pair[0] for pair in top_performers])
    return optimal  # e.g., 6.9 hours instead of 8.0
```

**Impact Example:**
```
Before (v0.4.0):
  Sleep Target: 8.0h (generic)
  Total Debt: 61.4h
  Status: üíÄ CRITICAL

After (v0.5.0):
  Personal Sleep Need: 6.9h (calculated)
  Total Debt: 30.1h
  Status: üî¥ ELEVATED
```

---

### 3. ‚öñÔ∏è Adaptive Severity Thresholds (NEW)

**Module:** `sleep_debt.py`, `alert_system.py` (enhanced)
**Feature:** Thresholds that scale to your personal sleep need

All severity classifications now adapt to your individual requirements using a scale factor:

**Scale Factor:** `personal_sleep_need / 8.0`

**New Severity Levels (5 instead of 4):**
- **Minimal:** < 0.25 nights (< 2h √ó scale_factor)
- **Mild:** < 1 night (< 8h √ó scale_factor)
- **Moderate:** < 2 nights (< 16h √ó scale_factor)
- **Elevated:** < 5 nights (< 40h √ó scale_factor) ‚¨ÖÔ∏è **NEW**
- **Severe:** < 7 nights (< 56h √ó scale_factor)
- **Critical:** >= 7 nights (>= 56h √ó scale_factor)

**Example:**
```
Personal Sleep Need: 6.9h
Scale Factor: 6.9 / 8.0 = 0.8625

Adjusted Thresholds:
  Moderate: < 13.8h (instead of 16h)
  Elevated: < 34.5h (instead of 40h)
  Severe:   < 48.3h (instead of 56h)
  Critical: >= 48.3h (instead of 56h)

Result: 30.1h debt = ELEVATED (not CRITICAL)
```

---

### 4. üö® Personalized Health Alerts (ENHANCED)

**Module:** `alert_system.py` (enhanced)
**Feature:** Alert thresholds scaled to personal metrics

All health alerts now use personalized thresholds:

**Sleep Duration Alerts:**
- Scaled by personal sleep need
- Short sleep threshold: `6h √ó scale_factor`
- Extremely short: `4h √ó scale_factor`

**Sleep Debt Alerts:**
- Scaled thresholds for warning/critical levels
- Personal need considered in consecutive bad nights

**Consecutive Bad Nights Logic:**
- **Fixed:** Now handles aggregated sessions (score may be 0)
- **Uses efficiency as proxy:** `score ‚âà efficiency √ó 1.2` when score unavailable
- **Dual criteria:** Bad night = `(score < 60) OR (score < 70 AND deficit > 1.0h)`

**Technical Implementation:**
```python
class AlertSystem:
    def __init__(self, personal_sleep_need: float = 8.0):
        self.personal_sleep_need = personal_sleep_need
        self.scale_factor = personal_sleep_need / 8.0
        self.scaled_thresholds = self._scale_thresholds()

    def _scale_thresholds(self):
        """Scale sleep-related thresholds."""
        scaled = {}
        for key, value in self.THRESHOLDS.items():
            if key in ['sleep_duration', 'sleep_debt']:
                scaled[key] = {
                    level: threshold * self.scale_factor
                    for level, threshold in value.items()
                }
        return scaled
```

---

## üêõ Bug Fixes

### 1. Chronotype Misclassification from Biphasic Sleep

**Issue:** Naps (e.g., 19:00-22:30 couch naps) were included in average bedtime calculation, skewing chronotype from expected "Night Owl" (01:00-02:00 bedtime) to "Intermediate" (22:48 bedtime).

**Root Cause:** Chronotype analyzer was receiving aggregated sleep sessions instead of raw sessions.

**Fix:**
- Modified `analyze_chronotype()` to accept raw sessions
- Created `_extract_main_sleep_sessions()` to filter naps:
  - For single session days: Keep if > 2 hours
  - For multiple session days: Keep longest if > 1 hour
- Changed `intelligence_tools.py` to pass raw sessions to analyzer

**Result:** Correctly identifies chronotype based on main sleep only.

---

### 2. Consecutive Bad Nights False Positives

**Issue:** Alert system showing "7 consecutive bad nights" when aggregated sleep sessions had `score = 0`.

**Root Cause:** Aggregated sessions lose score data, defaulting to 0/None.

**Fix:**
- Added efficiency-as-proxy logic: `score = min(100, efficiency √ó 1.2)` when score unavailable
- Enhanced bad night criteria: `(score < 60) OR (score < 70 AND deficit > 1.0h)`
- Considers both sleep quality and duration vs personal need

**Result:** No more false consecutive bad night alerts.

---

### 3. RHR Data Type Confusion

**Issue:** Illness detection displaying "Ruhepuls 92.7" as if it were BPM (beats per minute).

**Root Cause:** Oura API returns `resting_heart_rate` in readiness contributors as a **score (0-100)**, not absolute BPM.

**Fix:**
- Updated documentation: "RHR Score (0-100 scale), not absolute BPM"
- Inverted deviation logic: `deviation = baseline - avg_recent` (lower score = elevated HR)
- Changed reporting: "RHR Score: 87/100 *(score, not BPM)*"
- Updated alert messages: "RHR score X points below baseline (elevated HR)"

**Result:** Clear indication that values are scores, not raw BPM measurements.

---

## üîß Technical Changes

### New Files
- `src/oura_mcp/utils/chronotype_analysis.py` (~700 lines)

### Modified Files
- `src/oura_mcp/utils/sleep_debt.py` (~200 lines modified)
- `src/oura_mcp/utils/alert_system.py` (~150 lines modified)
- `src/oura_mcp/utils/illness_detection.py` (~50 lines modified)
- `src/oura_mcp/tools/intelligence_tools.py` (~100 lines modified)
- `src/oura_mcp/tools/analytics_tools.py` (~100 lines modified)

### Key Architectural Patterns

**1. Scale Factor Pattern:**
```python
scale_factor = personal_sleep_need / 8.0
scaled_threshold = base_threshold * scale_factor
```

**2. Main Sleep Extraction:**
```python
def _extract_main_sleep_sessions(sessions):
    sessions_by_day = defaultdict(list)
    for session in sessions:
        sessions_by_day[session['day']].append(session)

    main_sessions = []
    for day, day_sessions in sessions_by_day.items():
        if len(day_sessions) == 1:
            # Single session: keep if > 2h
            if session['total_sleep_duration'] >= 7200:
                main_sessions.append(session)
        else:
            # Multiple sessions: pick longest > 1h
            longest = max(day_sessions, key=lambda s: s['total_sleep_duration'])
            if longest['total_sleep_duration'] >= 3600:
                main_sessions.append(longest)

    return main_sessions
```

**3. Efficiency as Score Proxy:**
```python
if score is None or score == 0:
    efficiency = session.get('efficiency', 0)
    score = min(100, efficiency * 1.2) if efficiency else 50
```

---

## üìä Example Workflows

### Workflow 1: Getting Started with Personalized Insights
```
User: "What's my chronotype?"
‚Üí Analyzes 30 days of sleep timing
‚Üí Returns: "Night Owl" with MSF 05:06

User: "Calculate my personal sleep need"
‚Üí Analyzes readiness correlation
‚Üí Returns: 6.9h optimal (not 8h)

User: "What's my sleep debt?"
‚Üí Uses 6.9h target (not 8h)
‚Üí Returns: 30.1h debt (ELEVATED, not CRITICAL)
```

### Workflow 2: Understanding Your Results
```
User: "Check for health alerts"
‚Üí Scales all thresholds to your personal need
‚Üí Shows accurate alerts without false positives

User: "Generate weekly health report"
‚Üí All recommendations use personal sleep need
‚Üí Chronotype-aware scheduling suggestions
```

---

## üî¨ Scientific Basis

### Chronotype Classification
Based on **Roenneberg et al. chronobiology research**:
- MSF (Midpoint of Sleep on Free days) is the gold standard for chronotype assessment
- Accounts for social jetlag and sleep restriction during workdays
- Validated across thousands of subjects worldwide

### Personal Sleep Need
Based on **performance correlation methodology**:
- Top 25% readiness days indicate optimal recovery
- Individual sleep need varies 6-10 hours (Walker, "Why We Sleep")
- Genetic factors (PER3, CLOCK genes) influence duration requirements
- Night owls often need less sleep than early chronotypes

### Threshold Scaling
Based on **proportional debt theory**:
- Sleep debt severity should scale to individual needs
- 2 nights deficit = same physiological impact regardless of baseline
- Maintains scientific validity while personalizing

---

## üìà Performance Impact

- **Chronotype Analysis:** ~50ms for 30 days of data
- **Personal Sleep Need Calculation:** ~30ms for 30 days of data
- **Threshold Scaling:** Negligible (<1ms)
- **Memory Usage:** +2MB for chronotype analyzer

---

## üîÑ Migration Guide

### Breaking Changes
**None.** This release is fully backward compatible.

### Automatic Upgrades
- Sleep debt tracker now auto-detects personal sleep need (no config required)
- Alert system automatically uses personalized thresholds when readiness data available
- Existing tools continue to work with enhanced accuracy

### Optional Configuration
```yaml
# config.yaml - Optional overrides
health:
  sleep:
    personal_sleep_need: 7.0  # Override auto-detection
    chronotype: "night_owl"    # Override auto-classification
```

---

## üéØ User Benefits

### Before v0.5.0:
- ‚ùå Generic 8h sleep target for everyone
- ‚ùå Severity levels too strict for short sleepers
- ‚ùå No chronotype awareness
- ‚ùå Naps skewing chronotype classification
- ‚ùå False consecutive bad night alerts
- ‚ùå Unclear RHR data source

### After v0.5.0:
- ‚úÖ Personal sleep need calculated from your data
- ‚úÖ Severity levels scaled to your requirements
- ‚úÖ Scientific chronotype classification
- ‚úÖ Main sleep extracted from biphasic patterns
- ‚úÖ Accurate bad night detection
- ‚úÖ Clear score vs BPM labeling

---

## üß™ Testing

All features tested with:
- ‚úÖ 30+ days of real Oura Ring data
- ‚úÖ Biphasic sleep patterns (naps + main sleep)
- ‚úÖ Night owl chronotype validation
- ‚úÖ Readiness correlation accuracy
- ‚úÖ Threshold scaling verification
- ‚úÖ Edge cases (missing data, single sessions, etc.)

---

## üôè Acknowledgments

Special thanks to:
- **Till Roenneberg** for MSF chronotype methodology
- **Matthew Walker** for sleep science research
- **Real-world testing** with biphasic sleep patterns

---

## üêõ Known Issues

None identified.

---

## üöÄ What's Next

**Future Enhancements:**
- Multi-week chronotype trend analysis
- Chronotype drift detection (seasonal changes)
- Personalized optimal bedtime recommendations based on chronotype
- Integration with circadian rhythm predictions
- Sleep debt recovery optimization by chronotype

---

## üìû Support

- **Issues:** https://github.com/schimmmi/oura-mcp-server/issues
- **Documentation:** See `docs/` directory
- **Examples:** See `Example Queries` section in README.md

---

**Ready to discover your chronotype and personal sleep need? Update now and get truly personalized health insights! ü¶â‚ú®**
